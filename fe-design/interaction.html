<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>云商旅和共享交互设计 | 商旅wiki</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="docs">
    
    <link rel="preload" href="/assets/css/0.styles.5e669867.css" as="style"><link rel="preload" href="/assets/js/app.9b3a434f.js" as="script"><link rel="preload" href="/assets/js/2.1a7250fa.js" as="script"><link rel="preload" href="/assets/js/22.cde41abb.js" as="script"><link rel="preload" href="/assets/js/10.bf99ed7a.js" as="script"><link rel="preload" href="/assets/js/9.e8dca31a.js" as="script"><link rel="prefetch" href="/assets/js/11.cfed334c.js"><link rel="prefetch" href="/assets/js/12.c074498a.js"><link rel="prefetch" href="/assets/js/13.f76f5b1e.js"><link rel="prefetch" href="/assets/js/14.789df116.js"><link rel="prefetch" href="/assets/js/15.add2b6f5.js"><link rel="prefetch" href="/assets/js/16.67a5a539.js"><link rel="prefetch" href="/assets/js/17.b1ee3fbf.js"><link rel="prefetch" href="/assets/js/18.d431be62.js"><link rel="prefetch" href="/assets/js/19.8e230dd0.js"><link rel="prefetch" href="/assets/js/20.6d0e1aa2.js"><link rel="prefetch" href="/assets/js/21.f317845c.js"><link rel="prefetch" href="/assets/js/23.d7e4b9d9.js"><link rel="prefetch" href="/assets/js/24.e96b9c12.js"><link rel="prefetch" href="/assets/js/25.7eb5d3fe.js"><link rel="prefetch" href="/assets/js/26.c6acee12.js"><link rel="prefetch" href="/assets/js/27.a1809baa.js"><link rel="prefetch" href="/assets/js/28.a432a3f9.js"><link rel="prefetch" href="/assets/js/29.01eb7423.js"><link rel="prefetch" href="/assets/js/3.e96383b7.js"><link rel="prefetch" href="/assets/js/4.16e4171d.js"><link rel="prefetch" href="/assets/js/5.7e1db464.js"><link rel="prefetch" href="/assets/js/6.000db957.js"><link rel="prefetch" href="/assets/js/7.5885e145.js"><link rel="prefetch" href="/assets/js/8.932df417.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5e669867.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">商旅wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/Front-end-tools/" class="nav-link">
  前端开发工具
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  Design
</a></div><div class="nav-item"><a href="/trip/" class="nav-link">
  行程配置解读
</a></div><div class="nav-item"><a href="/fe-design/" class="nav-link router-link-active">
  前端设计方案
</a></div> <a href="https://github.com/yny-fe/wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/Front-end-tools/" class="nav-link">
  前端开发工具
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  Design
</a></div><div class="nav-item"><a href="/trip/" class="nav-link">
  行程配置解读
</a></div><div class="nav-item"><a href="/fe-design/" class="nav-link router-link-active">
  前端设计方案
</a></div> <a href="https://github.com/yny-fe/wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>云商旅前端设计方案</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-design/ai.html" class="sidebar-link">AI语音交互操作商旅</a></li><li><a href="/fe-design/interaction.html" aria-current="page" class="active sidebar-link">云商旅和ECS、共享交互设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-design/interaction.html#推送" class="sidebar-link">推送</a></li><li class="sidebar-sub-header"><a href="/fe-design/interaction.html#拉取" class="sidebar-link">拉取</a></li></ul></li><li><a href="/fe-design/sensors.html" class="sidebar-link">神策数据埋点设计方案</a></li><li><a href="/fe-design/pay.html" class="sidebar-link">酒店混付设计方案</a></li><li><a href="/fe-design/postmessage.html" class="sidebar-link">postMessage实现类</a></li><li><a href="/fe-design/third-supplier.html" class="sidebar-link">云商旅对接三方供应商【H5对接】</a></li><li><a href="/fe-design/performance.html" class="sidebar-link">前端渲染速度优化方案</a></li><li><a href="/fe-design/toggle-theme.html" class="sidebar-link">前端主题切换</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="云商旅和共享交互设计"><a href="#云商旅和共享交互设计" class="header-anchor">#</a> 云商旅和共享交互设计</h1> <p>背景：共享系统跟云商旅之间是通过iframe交互，也就是说共享一方会用iframe内嵌入云商旅的页面。站在云商旅的角度来看，跟共享系统交互有两类，<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>一、把数据从云商旅推送给共享系统</span><span class="badge tip" style="vertical-align:top;" data-v-15b7b770>二、把数据从共享拉到云商旅</span>。简单的说就是一个<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>推送</span>，一个<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>拉取</span>针对两类我们需要分别讨论：</p> <h2 id="推送"><a href="#推送" class="header-anchor">#</a> 推送</h2> <p>为了满足不同客户本身网络策略影响，我们有到目前实现了三种推送的方案。<p class="yellow-text">①postMessage</p> <p class="yellow-text">②form表单提交</p> <p class="yellow-text">③ 服务端接口转发</p>，下面一一说明这三种方式的实现。</p> <h3 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage</h3> <p>postMessage的主要产生原因是因为共享系统都是本地化部署给客户使用的，而部分金融类或银行类企业对网略策略管理较为严格，所以在共享和云交互的时候会受到各种限制。而postMessage是前端与前端之间安全的跨域通信的方案，所以通过这种方式能避免云商旅和共享系统之间的http请求。</p> <ul><li>postMessage的优点
<ul><li>使用简单</li> <li>传输比较安全，不会像http协议传输那样被拦截</li> <li>可以解决iframe之间跨域通信</li></ul></li> <li>postMessage的缺点
<ul><li>出现bug不利于排查</li> <li>没法像后台接口那样记录操作日志</li> <li>没法把一系列的请求链用promise连接起来，不利于代码逻辑管理</li></ul></li></ul> <h3 id="form"><a href="#form" class="header-anchor">#</a> form</h3> <p>form表单作为最早跟E7对接时候所约定的标准，那时候的客户还没有遇到类似银行类或金融类企业有严格的内网策略，所以通过form表单的方式是可以实现云商旅和共享之间的数据交互的。</p> <ul><li>实现原理
<ul><li>共享系统在进入云商旅页面的时候会被要求传一个callbackURL的参数，这个参数的作用很简单，就是用来接收云商旅这边推送过去的数据，这个callbackURL是标准的后台api接口，在进行到最后一步的时候云商旅前端会模拟form表单提交，把云商旅的数据通过from表单推送到callbackURL这个地址，共享拿到数据后再渲染页面，到此云商旅的界面操作流程结束。</li></ul></li></ul> <h3 id="server-proxy"><a href="#server-proxy" class="header-anchor">#</a> server-proxy</h3> <p>顾名思义，server-proxy就是服务端代理，相比于form表单云商旅前端直接通过调用共享的接口来进行数据通信，服务端代理的做法是通过云商旅的服务端去做调用接口这个事情。</p> <h2 id="拉取"><a href="#拉取" class="header-anchor">#</a> 拉取</h2> <p>同理，拉取有时候也会遇到客户那边网络策略的原因，所以我们有时候并不能使用标准的api接口，目前拉取有两种方案：<p class="yellow-text">①postMessage</p> <p class="yellow-text">②后台标准API【接口】</p></p> <h3 id="postmessage-2"><a href="#postmessage-2" class="header-anchor">#</a> postMessage</h3> <p>相较于推送时候使用postMessage，拉取使用postMessage更麻烦一点。举个栗子：
假设现在某个业务逻辑有三个异步请求，分别为A【获取当前人员信息】,B【获取差旅标准】,C【判断这个人是否超标】，这三个异步请求要依次调用A -&gt; B -&gt; C，也就是说A调完后才能调用B，B调完后才能调C</p> <h4 id="标准后台api对接的情况下-我们的逻辑是这样的"><a href="#标准后台api对接的情况下-我们的逻辑是这样的" class="header-anchor">#</a> 标准后台API对接的情况下，我们的逻辑是这样的</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取到人员为a</span>
    <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取到人员a的差旅标准为b</span>
      <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 得到人员a是否超标为c</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到上面的逻辑非常清楚，可以看到整个操作是链式的，依次递进</p> <h4 id="采用postmessage的方式-逻辑是这样的"><a href="#采用postmessage的方式-逻辑是这样的" class="header-anchor">#</a> 采用postMessage的方式，逻辑是这样的</h4> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">monitor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">eventName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">getA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取到当前登录人信息，然后通过postMessage把a推给共享，获取a的标准</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">monitor</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 监听到共享有推送消息给云商旅，值为e，e里面包含了差旅标准b，也即，e.b</span>
  <span class="token comment">// 得到a的差旅标准为e.b，然后调用接口判断是否超标</span>
  <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 得到结果</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注意上面的代码，第7行是我们发送postMessage获取差旅标准，而处理差旅标准需要跳到13,14,15行去处理，也就是说发送跟处理结果被两个函数隔开了，这点对于处理业务逻辑来说相当不方便</p> <ul><li>优点
<ul><li>可以解决跨iframe跨域的问题</li> <li>可以解决客户因网络严格限制无法对外暴露接口的情况</li></ul></li> <li>缺点
<ul><li>云商旅开发严重依赖共享的iframe，脱离iframe云商旅好多逻辑走不下去</li> <li>联调开发阶段比较痛苦，效率低下</li></ul></li></ul> <h3 id="api"><a href="#api" class="header-anchor">#</a> API</h3> <p>采用API的方式通过接口获取数据是最为方便的一种方式，例如获取人员信息，E7时代获取差旅标准接口等。</p> <ul><li>优点
<ul><li>能记录log日志，方便追查定位问题</li> <li>标准对接，云商旅一方不依赖iframe</li> <li>对接简单，方便快捷</li></ul></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yny-fe/wiki/edit/main/docs/fe-design/interaction.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/24/2022, 2:45:26 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-design/ai.html" class="prev">
        AI语音交互操作商旅
      </a></span> <span class="next"><a href="/fe-design/sensors.html">
        神策数据埋点设计方案
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9b3a434f.js" defer></script><script src="/assets/js/2.1a7250fa.js" defer></script><script src="/assets/js/22.cde41abb.js" defer></script><script src="/assets/js/10.bf99ed7a.js" defer></script><script src="/assets/js/9.e8dca31a.js" defer></script>
  </body>
</html>
